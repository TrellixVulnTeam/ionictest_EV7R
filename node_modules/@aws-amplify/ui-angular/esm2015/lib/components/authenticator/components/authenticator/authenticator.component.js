import { ChangeDetectorRef, Component, ContentChildren, Input, ViewEncapsulation, } from '@angular/core';
import { defaultAuthHubHandler, listenToAuthHub, translate, } from '@aws-amplify/ui';
import { AmplifySlotDirective } from '../../../../utilities/amplify-slot/amplify-slot.directive';
import { CustomComponentsService } from '../../../../services/custom-components.service';
import { AuthenticatorService } from '../../../../services/authenticator.service';
export class AuthenticatorComponent {
    constructor(authenticator, contextService, changeDetector) {
        this.authenticator = authenticator;
        this.contextService = contextService;
        this.changeDetector = changeDetector;
        this.customComponentQuery = null;
        // translated texts
        this.signInTitle = translate('Sign In');
        this.signUpTitle = translate('Create Account');
        this.hasInitialized = false;
        this.isHandlingHubEvent = false;
    }
    ngOnInit() {
        const { initialState, loginMechanisms, services, signUpAttributes, socialProviders, formFields, } = this;
        const { authService } = this.authenticator;
        this.unsubscribeHub = listenToAuthHub(authService, (data, service) => {
            defaultAuthHubHandler(data, service);
            /**
             * Hub events aren't properly caught by Angular, because they are
             * synchronous events. Angular tracks async network events and
             * html events, but not synchronous events like hub.
             *
             * On any notable hub events, we run change detection manually.
             */
            this.changeDetector.detectChanges();
            /**
             * Hub events that we handle can lead to multiple state changes:
             * e.g. `authenticated` -> `signOut` -> initialState.
             *
             * We want to ensure change detection runs all the way, until
             * we reach back to the initial state. Setting the below flag
             * to true to until we reach initial state.
             */
            this.isHandlingHubEvent = true;
        });
        /**
         * Subscribes to state machine changes and sends INIT event
         * once machine reaches 'setup' state.
         */
        this.unsubscribeMachine = this.authenticator.subscribe(() => {
            const { route } = this.authenticator;
            if (this.isHandlingHubEvent) {
                this.changeDetector.detectChanges();
                const initialStateWithDefault = initialState !== null && initialState !== void 0 ? initialState : 'signIn';
                // We can stop manual change detection if we're back to the initial state
                if (route === initialStateWithDefault) {
                    this.isHandlingHubEvent = false;
                }
            }
            if (!this.hasInitialized && route === 'setup') {
                this.authenticator.send({
                    type: 'INIT',
                    data: {
                        initialState,
                        loginMechanisms,
                        services,
                        signUpAttributes,
                        socialProviders,
                        formFields,
                    },
                });
                this.hasInitialized = true;
            }
        }).unsubscribe;
        /**
         * handling translations after content init, because authenticator and its
         * translations might be initialized before the main app's `ngOnInit` is run.
         */
        this.signInTitle = translate('Sign In');
        this.signUpTitle = translate('Create Account');
    }
    /**
     * Lifecycle Methods
     */
    ngAfterContentInit() {
        this.contextService.customComponents = this.mapCustomComponents(this.customComponentQuery);
    }
    ngOnDestroy() {
        if (this.unsubscribeMachine)
            this.unsubscribeMachine();
        if (this.unsubscribeHub)
            this.unsubscribeHub();
    }
    /**
     * Class Functions
     */
    // context passed to "authenticated" slot
    get context() {
        return this.authenticator.slotContext;
    }
    get route() {
        return this.authenticator.route;
    }
    onTabChange() {
        const route = this.authenticator.route;
        if (route === 'signIn') {
            this.authenticator.toSignUp();
        }
        else {
            this.authenticator.toSignIn();
        }
    }
    hasTabs() {
        const { route } = this.authenticator;
        return route === 'signIn' || route === 'signUp';
    }
    hasRouteComponent() {
        const { route } = this.authenticator;
        switch (route) {
            case 'authenticated':
            case 'idle':
            case 'setup':
            case 'signOut':
            case 'autoSignIn':
                return false;
            default:
                return true;
        }
    }
    mapCustomComponents(componentQuery) {
        if (!componentQuery)
            return {};
        const customComponents = {};
        componentQuery.forEach((component) => {
            customComponents[component.name] = component.template;
        });
        return customComponents;
    }
}
AuthenticatorComponent.decorators = [
    { type: Component, args: [{
                selector: 'amplify-authenticator',
                template: "<div\n  data-amplify-authenticator\n  [attr.data-variation]=\"variation\"\n  *ngIf=\"hasRouteComponent()\"\n>\n  <div data-amplify-container>\n    <amplify-slot name=\"header\" [context]=\"context\"></amplify-slot>\n    <div\n      data-amplify-router\n      [attr.data-amplify-router-content]=\"hasTabs() ? undefined : ''\"\n    >\n      <amplify-tabs\n        (tabChange)=\"onTabChange()\"\n        *ngIf=\"(route === 'signIn' || route === 'signUp') && !hideSignUp\"\n      >\n        <amplify-tab-item\n          [title]=\"signInTitle\"\n          [active]=\"route === 'signIn'\"\n          data-amplify-router-content\n        >\n          <!-- signIn component -->\n          <amplify-slot\n            name=\"sign-in\"\n            [context]=\"context\"\n            *ngIf=\"route === 'signIn'\"\n          >\n            <amplify-sign-in></amplify-sign-in>\n          </amplify-slot>\n        </amplify-tab-item>\n        <amplify-tab-item\n          [title]=\"signUpTitle\"\n          [active]=\"route === 'signUp'\"\n          data-amplify-router-content\n        >\n          <!-- signUp component -->\n          <amplify-slot\n            name=\"sign-up\"\n            [context]=\"context\"\n            *ngIf=\"route === 'signUp'\"\n          >\n            <amplify-sign-up></amplify-sign-up>\n          </amplify-slot>\n        </amplify-tab-item>\n      </amplify-tabs>\n\n      <amplify-slot\n        name=\"sign-in\"\n        [context]=\"context\"\n        *ngIf=\"route === 'signIn' && hideSignUp\"\n      >\n        <amplify-sign-in></amplify-sign-in>\n      </amplify-slot>\n\n      <!-- confirmSignUp content -->\n      <amplify-slot\n        name=\"confirm-sign-up\"\n        [context]=\"context\"\n        *ngIf=\"route === 'confirmSignUp'\"\n      >\n        <amplify-confirm-sign-up></amplify-confirm-sign-up>\n      </amplify-slot>\n\n      <!-- confirmSignIn content -->\n      <amplify-slot\n        name=\"confirm-sign-in\"\n        [context]=\"context\"\n        *ngIf=\"route === 'confirmSignIn'\"\n      >\n        <amplify-confirm-sign-in></amplify-confirm-sign-in>\n      </amplify-slot>\n\n      <!-- setupTotp content -->\n      <amplify-slot\n        name=\"setup-totp\"\n        [context]=\"context\"\n        *ngIf=\"route === 'setupTOTP'\"\n      >\n        <amplify-setup-totp></amplify-setup-totp>\n      </amplify-slot>\n\n      <!-- forceNewPassword content -->\n      <amplify-slot\n        name=\"force-new-password\"\n        [context]=\"context\"\n        *ngIf=\"route === 'forceNewPassword'\"\n      >\n        <amplify-force-new-password></amplify-force-new-password>\n      </amplify-slot>\n\n      <!-- resetPassword content -->\n      <amplify-slot\n        name=\"reset-password\"\n        [context]=\"context\"\n        *ngIf=\"route === 'resetPassword'\"\n      >\n        <amplify-reset-password></amplify-reset-password>\n      </amplify-slot>\n\n      <!-- confirmResetPassword content -->\n      <amplify-slot\n        name=\"confirm-reset-password\"\n        [context]=\"context\"\n        *ngIf=\"route === 'confirmResetPassword'\"\n      >\n        <amplify-confirm-reset-password></amplify-confirm-reset-password>\n      </amplify-slot>\n\n      <!-- verifyUser content -->\n      <amplify-slot\n        name=\"verify-user\"\n        [context]=\"context\"\n        *ngIf=\"route === 'verifyUser'\"\n      >\n        <amplify-verify-user></amplify-verify-user>\n      </amplify-slot>\n\n      <!-- confirmVerifyUser content -->\n      <amplify-slot\n        name=\"confirm-verify-user\"\n        [context]=\"context\"\n        *ngIf=\"route === 'confirmVerifyUser'\"\n      >\n        <amplify-confirm-verify-user></amplify-confirm-verify-user>\n      </amplify-slot>\n    </div>\n\n    <amplify-slot name=\"footer\" [context]=\"context\"></amplify-slot>\n  </div>\n</div>\n\n<!-- signedIn content is rendered outside authenticator so it's not styled by authenticator -->\n<amplify-slot\n  name=\"authenticated\"\n  [context]=\"context\"\n  *ngIf=\"route === 'authenticated'\"\n>\n  <ng-content></ng-content>\n</amplify-slot>\n",
                providers: [CustomComponentsService],
                encapsulation: ViewEncapsulation.None
            },] }
];
AuthenticatorComponent.ctorParameters = () => [
    { type: AuthenticatorService },
    { type: CustomComponentsService },
    { type: ChangeDetectorRef }
];
AuthenticatorComponent.propDecorators = {
    formFields: [{ type: Input }],
    initialState: [{ type: Input }],
    loginMechanisms: [{ type: Input }],
    services: [{ type: Input }],
    signUpAttributes: [{ type: Input }],
    socialProviders: [{ type: Input }],
    variation: [{ type: Input }],
    hideSignUp: [{ type: Input }],
    customComponentQuery: [{ type: ContentChildren, args: [AmplifySlotDirective,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS1hbmd1bGFyL3NyYy9saWIvY29tcG9uZW50cy9hdXRoZW50aWNhdG9yL2NvbXBvbmVudHMvYXV0aGVudGljYXRvci9hdXRoZW50aWNhdG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxlQUFlLEVBQ2YsS0FBSyxFQUtMLGlCQUFpQixHQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBRUwscUJBQXFCLEVBQ3JCLGVBQWUsRUFFZixTQUFTLEdBQ1YsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwyREFBMkQsQ0FBQztBQUNqRyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxnREFBZ0QsQ0FBQztBQUN6RixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQVFsRixNQUFNLE9BQU8sc0JBQXNCO0lBd0JqQyxZQUNVLGFBQW1DLEVBQ25DLGNBQXVDLEVBQ3ZDLGNBQWlDO1FBRmpDLGtCQUFhLEdBQWIsYUFBYSxDQUFzQjtRQUNuQyxtQkFBYyxHQUFkLGNBQWMsQ0FBeUI7UUFDdkMsbUJBQWMsR0FBZCxjQUFjLENBQW1CO1FBZG5DLHlCQUFvQixHQUFvQyxJQUFJLENBQUM7UUFFckUsbUJBQW1CO1FBQ1osZ0JBQVcsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkMsZ0JBQVcsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUV6QyxtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUN2Qix1QkFBa0IsR0FBRyxLQUFLLENBQUM7SUFRaEMsQ0FBQztJQUVKLFFBQVE7UUFDTixNQUFNLEVBQ0osWUFBWSxFQUNaLGVBQWUs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b3J0IHtcbiAgQWZ0ZXJDb250ZW50SW5pdCxcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIENvbXBvbmVudCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIFF1ZXJ5TGlzdCxcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEF1dGhlbnRpY2F0b3JNYWNoaW5lT3B0aW9ucyxcbiAgZGVmYXVsdEF1dGhIdWJIYW5kbGVyLFxuICBsaXN0ZW5Ub0F1dGhIdWIsXG4gIFNvY2lhbFByb3ZpZGVyLFxuICB0cmFuc2xhdGUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS91aSc7XG5pbXBvcnQgeyBBbXBsaWZ5U2xvdERpcmVjdGl2ZSB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxpdGllcy9hbXBsaWZ5LXNsb3QvYW1wbGlmeS1zbG90LmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBDdXN0b21Db21wb25lbnRzU2VydmljZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NlcnZpY2VzL2N1c3RvbS1jb21wb25lbnRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXV0aGVudGljYXRvclNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi8uLi9zZXJ2aWNlcy9hdXRoZW50aWNhdG9yLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdhbXBsaWZ5LWF1dGhlbnRpY2F0b3InLFxuICB0ZW1wbGF0ZVVybDogJy4vYXV0aGVudGljYXRvci5jb21wb25lbnQuaHRtbCcsXG4gIHByb3ZpZGVyczogW0N1c3RvbUNvbXBvbmVudHNTZXJ2aWNlXSwgLy8gbWFrZSBzdXJlIGN1c3RvbSBjb21wb25lbnRzIGFyZSBzY29wZWQgdG8gdGhpcyBhdXRoZW50aWNhdG9yIG9ubHlcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbn0pXG5leHBvcnQgY2xhc3MgQXV0aGVudGljYXRvckNvbXBvbmVudFxuICBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95XG57XG4gIEBJbnB1dCgpIGZvcm1GaWVsZHM6IEF1dGhlbnRpY2F0b3JNYWNoaW5lT3B0aW9uc1snZm9ybUZpZWxkcyddO1xuICBASW5wdXQoKSBpbml0aWFsU3RhdGU6IEF1dGhlbnRpY2F0b3JNYWNoaW5lT3B0aW9uc1snaW5pdGlhbFN0YXRlJ107XG4gIEBJbnB1dCgpIGxvZ2luTWVjaGFuaXNtczogQXV0aGVudGljYXRvck1hY2hpbmVPcHRpb25zWydsb2dpbk1lY2hhbmlzbXMnXTtcbiAgQElucHV0KCkgc2VydmljZXM6IEF1dGhlbnRpY2F0b3JNYWNoaW5lT3B0aW9uc1snc2VydmljZXMnXTtcbiAgQElucHV0KCkgc2lnblVwQXR0cmlidXRlczogQXV0aGVudGljYXRvck1hY2hpbmVPcHRpb25zWydzaWduVXBBdHRyaWJ1dGVzJ107XG4gIEBJbnB1dCgpIHNvY2lhbFByb3ZpZGVyczogU29jaWFsUHJvdmlkZXJbXTtcbiAgQElucHV0KCkgdmFyaWF0aW9uOiAnZGVmYXVsdCcgfCAnbW9kYWwnO1xuICBASW5wdXQoKSBoaWRlU2lnblVwOiBib29sZWFuO1xuXG4gIEBDb250ZW50Q2hpbGRyZW4oQW1wbGlmeVNsb3REaXJlY3RpdmUpXG4gIHByaXZhdGUgY3VzdG9tQ29tcG9uZW50UXVlcnk6IFF1ZXJ5TGlzdDxBbXBsaWZ5U2xvdERpcmVjdGl2ZT4gPSBudWxsO1xuXG4gIC8vIHRyYW5zbGF0ZWQgdGV4dHNcbiAgcHVibGljIHNpZ25JblRpdGxlID0gdHJhbnNsYXRlKCdTaWduIEluJyk7XG4gIHB1YmxpYyBzaWduVXBUaXRsZSA9IHRyYW5zbGF0ZSgnQ3JlYXRlIEFjY291bnQnKTtcblxuICBwcml2YXRlIGhhc0luaXRpYWxpemVkID0gZmFsc2U7XG4gIHByaXZhdGUgaXNIYW5kbGluZ0h1YkV2ZW50ID0gZmFsc2U7XG4gIHByaXZhdGUgdW5zdWJzY3JpYmVNYWNoaW5lOiAoKSA9PiB2b2lkO1xuICBwcml2YXRlIHVuc3Vic2NyaWJlSHViOiBSZXR1cm5UeXBlPHR5cGVvZiBsaXN0ZW5Ub0F1dGhIdWI+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYXV0aGVudGljYXRvcjogQXV0aGVudGljYXRvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjb250ZXh0U2VydmljZTogQ3VzdG9tQ29tcG9uZW50c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWZcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIGNvbnN0IHtcbiAgICAgIGluaXRpYWxTdGF0ZSxcbiAgICAgIGxvZ2luTWVjaGFuaXNtcyxcbiAgICAgIHNlcnZpY2VzLFxuICAgICAgc2lnblVwQXR0cmlidXRlcyxcbiAgICAgIHNvY2lhbFByb3ZpZGVycyxcbiAgICAgIGZvcm1GaWVsZHMsXG4gICAgfSA9IHRoaXM7XG5cbiAgICBjb25zdCB7IGF1dGhTZXJ2aWNlIH0gPSB0aGlzLmF1dGhlbnRpY2F0b3I7XG5cbiAgICB0aGlzLnVuc3Vic2NyaWJlSHViID0gbGlzdGVuVG9BdXRoSHViKGF1dGhTZXJ2aWNlLCAoZGF0YSwgc2VydmljZSkgPT4ge1xuICAgICAgZGVmYXVsdEF1dGhIdWJIYW5kbGVyKGRhdGEsIHNlcnZpY2UpO1xuICAgICAgLyoqXG4gICAgICAgKiBIdWIgZXZlbnRzIGFyZW4ndCBwcm9wZXJseSBjYXVnaHQgYnkgQW5ndWxhciwgYmVjYXVzZSB0aGV5IGFyZVxuICAgICAgICogc3luY2hyb25vdXMgZXZlbnRzLiBBbmd1bGFyIHRyYWNrcyBhc3luYyBuZXR3b3JrIGV2ZW50cyBhbmRcbiAgICAgICAqIGh0bWwgZXZlbnRzLCBidXQgbm90IHN5bmNocm9ub3VzIGV2ZW50cyBsaWtlIGh1Yi5cbiAgICAgICAqXG4gICAgICAgKiBPbiBhbnkgbm90YWJsZSBodWIgZXZlbnRzLCB3ZSBydW4gY2hhbmdlIGRldGVjdGlvbiBtYW51YWxseS5cbiAgICAgICAqL1xuICAgICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICAgIC8qKlxuICAgICAgICogSHViIGV2ZW50cyB0aGF0IHdlIGhhbmRsZSBjYW4gbGVhZCB0byBtdWx0aXBsZSBzdGF0ZSBjaGFuZ2VzOlxuICAgICAgICogZS5nLiBgYXV0aGVudGljYXRlZGAgLT4gYHNpZ25PdXRgIC0+IGluaXRpYWxTdGF0ZS5cbiAgICAgICAqXG4gICAgICAgKiBXZSB3YW50IHRvIGVuc3VyZSBjaGFuZ2UgZGV0ZWN0aW9uIHJ1bnMgYWxsIHRoZSB3YXksIHVudGlsXG4gICAgICAgKiB3ZSByZWFjaCBiYWNrIHRvIHRoZSBpbml0aWFsIHN0YXRlLiBTZXR0aW5nIHRoZSBiZWxvdyBmbGFnXG4gICAgICAgKiB0byB0cnVlIHRvIHVudGlsIHdlIHJlYWNoIGluaXRpYWwgc3RhdGUuXG4gICAgICAgKi9cbiAgICAgIHRoaXMuaXNIYW5kbGluZ0h1YkV2ZW50ID0gdHJ1ZTtcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZXMgdG8gc3RhdGUgbWFjaGluZSBjaGFuZ2VzIGFuZCBzZW5kcyBJTklUIGV2ZW50XG4gICAgICogb25jZSBtYWNoaW5lIHJlYWNoZXMgJ3NldHVwJyBzdGF0ZS5cbiAgICAgKi9cbiAgICB0aGlzLnVuc3Vic2NyaWJlTWFjaGluZSA9IHRoaXMuYXV0aGVudGljYXRvci5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgY29uc3QgeyByb3V0ZSB9ID0gdGhpcy5hdXRoZW50aWNhdG9yO1xuXG4gICAgICBpZiAodGhpcy5pc0hhbmRsaW5nSHViRXZlbnQpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICAgICAgY29uc3QgaW5pdGlhbFN0YXRlV2l0aERlZmF1bHQgPSBpbml0aWFsU3RhdGUgPz8gJ3NpZ25Jbic7XG5cbiAgICAgICAgLy8gV2UgY2FuIHN0b3AgbWFudWFsIGNoYW5nZSBkZXRlY3Rpb24gaWYgd2UncmUgYmFjayB0byB0aGUgaW5pdGlhbCBzdGF0ZVxuICAgICAgICBpZiAocm91dGUgPT09IGluaXRpYWxTdGF0ZVdpdGhEZWZhdWx0KSB7XG4gICAgICAgICAgdGhpcy5pc0hhbmRsaW5nSHViRXZlbnQgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMuaGFzSW5pdGlhbGl6ZWQgJiYgcm91dGUgPT09ICdzZXR1cCcpIHtcbiAgICAgICAgdGhpcy5hdXRoZW50aWNhdG9yLnNlbmQoe1xuICAgICAgICAgIHR5cGU6ICdJTklUJyxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBpbml0aWFsU3RhdGUsXG4gICAgICAgICAgICBsb2dpbk1lY2hhbmlzbXMsXG4gICAgICAgICAgICBzZXJ2aWNlcyxcbiAgICAgICAgICAgIHNpZ25VcEF0dHJpYnV0ZXMsXG4gICAgICAgICAgICBzb2NpYWxQcm92aWRlcnMsXG4gICAgICAgICAgICBmb3JtRmllbGRzLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaGFzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH0pLnVuc3Vic2NyaWJlO1xuXG4gICAgLyoqXG4gICAgICogaGFuZGxpbmcgdHJhbnNsYXRpb25zIGFmdGVyIGNvbnRlbnQgaW5pdCwgYmVjYXVzZSBhdXRoZW50aWNhdG9yIGFuZCBpdHNcbiAgICAgKiB0cmFuc2xhdGlvbnMgbWlnaHQgYmUgaW5pdGlhbGl6ZWQgYmVmb3JlIHRoZSBtYWluIGFwcCdzIGBuZ09uSW5pdGAgaXMgcnVuLlxuICAgICAqL1xuICAgIHRoaXMuc2lnbkluVGl0bGUgPSB0cmFuc2xhdGUoJ1NpZ24gSW4nKTtcbiAgICB0aGlzLnNpZ25VcFRpdGxlID0gdHJhbnNsYXRlKCdDcmVhdGUgQWNjb3VudCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIExpZmVjeWNsZSBNZXRob2RzXG4gICAqL1xuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5jb250ZXh0U2VydmljZS5jdXN0b21Db21wb25lbnRzID0gdGhpcy5tYXBDdXN0b21Db21wb25lbnRzKFxuICAgICAgdGhpcy5jdXN0b21Db21wb25lbnRRdWVyeVxuICAgICk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy51bnN1YnNjcmliZU1hY2hpbmUpIHRoaXMudW5zdWJzY3JpYmVNYWNoaW5lKCk7XG4gICAgaWYgKHRoaXMudW5zdWJzY3JpYmVIdWIpIHRoaXMudW5zdWJzY3JpYmVIdWIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGFzcyBGdW5jdGlvbnNcbiAgICovXG5cbiAgLy8gY29udGV4dCBwYXNzZWQgdG8gXCJhdXRoZW50aWNhdGVkXCIgc2xvdFxuICBwdWJsaWMgZ2V0IGNvbnRleHQoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXV0aGVudGljYXRvci5zbG90Q29udGV4dDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcm91dGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXV0aGVudGljYXRvci5yb3V0ZTtcbiAgfVxuXG4gIHB1YmxpYyBvblRhYkNoYW5nZSgpIHtcbiAgICBjb25zdCByb3V0ZSA9IHRoaXMuYXV0aGVudGljYXRvci5yb3V0ZTtcbiAgICBpZiAocm91dGUgPT09ICdzaWduSW4nKSB7XG4gICAgICB0aGlzLmF1dGhlbnRpY2F0b3IudG9TaWduVXAoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hdXRoZW50aWNhdG9yLnRvU2lnbkluKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhhc1RhYnMoKSB7XG4gICAgY29uc3QgeyByb3V0ZSB9ID0gdGhpcy5hdXRoZW50aWNhdG9yO1xuICAgIHJldHVybiByb3V0ZSA9PT0gJ3NpZ25JbicgfHwgcm91dGUgPT09ICdzaWduVXAnO1xuICB9XG5cbiAgcHVibGljIGhhc1JvdXRlQ29tcG9uZW50KCkge1xuICAgIGNvbnN0IHsgcm91dGUgfSA9IHRoaXMuYXV0aGVudGljYXRvcjtcblxuICAgIHN3aXRjaCAocm91dGUpIHtcbiAgICAgIGNhc2UgJ2F1dGhlbnRpY2F0ZWQnOlxuICAgICAgY2FzZSAnaWRsZSc6XG4gICAgICBjYXNlICdzZXR1cCc6XG4gICAgICBjYXNlICdzaWduT3V0JzpcbiAgICAgIGNhc2UgJ2F1dG9TaWduSW4nOlxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1hcEN1c3RvbUNvbXBvbmVudHMoXG4gICAgY29tcG9uZW50UXVlcnk6IFF1ZXJ5TGlzdDxBbXBsaWZ5U2xvdERpcmVjdGl2ZT5cbiAgKTogUmVjb3JkPHN0cmluZywgVGVtcGxhdGVSZWY8YW55Pj4ge1xuICAgIGlmICghY29tcG9uZW50UXVlcnkpIHJldHVybiB7fTtcbiAgICBjb25zdCBjdXN0b21Db21wb25lbnRzOiBSZWNvcmQ8c3RyaW5nLCBUZW1wbGF0ZVJlZjxhbnk+PiA9IHt9O1xuICAgIGNvbXBvbmVudFF1ZXJ5LmZvckVhY2goKGNvbXBvbmVudCkgPT4ge1xuICAgICAgY3VzdG9tQ29tcG9uZW50c1tjb21wb25lbnQubmFtZV0gPSBjb21wb25lbnQudGVtcGxhdGU7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY3VzdG9tQ29tcG9uZW50cztcbiAgfVxufVxuIl19